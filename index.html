<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
		<script src="recipes.json"></script>
		<script src="gear.json"></script>
		<script src="heroes.json"></script>
		<script>
			var needed = {};
			var cost = 0;
			function sanity_check() {
				var litmus = false;
				$.each(heroes, function(hk,hero) {
					$.each(hero.gearsets, function(gk,gearset) {
						$.each(gearset, function(slot,item) {
							if(false === item in gear) {
								$('#error').html($('#error').html() + 'UNMATCHED GEAR: ' + hk + '/' + gk + '/' + (slot + 1) + '/' + item + '<br />');
								litmus = true;
							}
						});
					});
				});
				$.each(recipes, function(rk,recipe) {
					$.each(recipe.materials, function(mk,material) {
						if(false === material.item in gear && false === material.item in recipes) {
							$('#error').html($('#error').html() + 'UNMATCHED GEAR: ' + rk + '/' + mk + '/' + material.item + '<br />');								litmus = true;
						}
					});
				});
				if(false === litmus) {
					populate_heroes();
				}
			}
			function populate_heroes() {
				$.each(heroes, function(hk,hero) {
					var result = '<h3>' + hero.name + ' (<span onclick="check_gearsets(\'' + hk + '\');">mark as completed</span>)</h3>';
					$.each(hero.gearsets, function(gk,gearset) {
						result += '<h4 class="' + gk + '">' + gk + ' (<span onclick="check_gearset(\'' + hk + gk + '\');">mark as completed</span>)</h4>';
						result += '<ul id="' + hk + gk + '" class="' + gk + '">';
						$.each(gearset, function(slot,item) {
							result += '<li><input type="checkbox" id="' + hk + gk + slot + '" onchange="calculate_gear();" /> ' + gear[item].name + '</li>';
						});
						result += '</ul>'
					});
					$('#heroes').html($('#heroes').html() + result);
				});
				calculate_gear();
			}
			function check_gearsets(id) {
				$.each(heroes[id].gearsets, function(gk,gearset) {
					check_gearset(id + gk);
				});
			}
			function check_gearset(id) {
				$('#' + id + ' li input').prop('checked', true);
				calculate_gear();
			}
			function calculate_recipe(recipe) {
				cost += recipe.cost;
				$('#gold').html(cost);
				$.each(recipe.materials, function(k,material) {
					if(false === material.item in needed) {
						needed[material.item] = material.quantity;
					} else {
						needed[material.item] += material.quantity;
					}
					if(true === material.item in recipes) {
						var i = 0;
						while(i < material.quantity) {
							calculate_recipe(recipes[material.item]);
							i++;
						}
					}
				});
			}
			function calculate_gear() {
				needed = {};
				cost = 0;
				$.each(heroes, function(hk,hero) {
					$.each(hero.gearsets, function(gk,gearset) {
						$.each(gearset, function(slot,item) {
							if(false === $('#' + hk + gk + slot).is(':checked')) {
								if(false === item in needed) {
					 				needed[item] = 1;
								} else {
									needed[item] += 1;
								}
								if(true === item in recipes) {
									calculate_recipe(recipes[item]);
								}
							}
						});
					});
				});
				var needed_sortable = [];
				$.each(needed, function(k,v) {
					needed_sortable.push({"item" : gear[k], "quantity" : v});
				}
				needed_sortable.sort(function(a,b) {
					var diff = a.quantity - b.quantity;
					if(0 === diff) {
						return(a.item.name - b.item.name);
					} else {
						return(diff);
					}
				});
				$('#white, #green, #blue, #purple, #orange').html('');
				$.each(needed_sortable, function(k,v) {
					$('#' + v.item.color).html($('#' + v.item.color).html() + '<li>' + v.item.name + ': ' + v.quantity + '</li>');
				});
			}
			$(function() { sanity_check(); });
		</script>
		<style>
			#error { background:red; color:white; }
			h4 { text-transform:capitalize; }
			span { text-transform:lowercase; color:#666; }
			.green { color:green }
			.blue { color:blue }
			.purple { color:purple }
			.orange { color:orange }
		</style>
	</head>
	<body>
		<h1>DragonSoul RPG Gear Calculator</h1>
		<div id="error"></div>
 		<h2>Gold Needed</h2>
 		<p id="gold"></p>
		<h2>Items Needed</h2>
		<h3>White</h3>
		<ul id="white"></ul>
		<h3 class="green">Green</h3>
		<ul id="green" class="green"></ul>
		<h3 class="blue">Blue</h3>
		<ul id="blue" class="blue"></ul>
		<h3 class="purple">Purple</h3>
		<ul id="purple" class="purple"></ul>
		<h3 class="orange">Orange</h3>
		<ul id="orange" class="orange"></ul>
		<h2>Heroes</h2>
		<div id="heroes"></div>
	</body>
</html>
